name: Pre-check New Issues

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  compare-versions:
    name: Compare IPT and GBIF Versions
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'issues'
    runs-on: ubuntu-latest
    env:
      GBIF_USER: ${{ secrets.GBIF_USER }}
      GBIF_PWD: ${{ secrets.GBIF_PWD }}
      GBIF_EMAIL: ${{ secrets.GBIF_EMAIL }}
    outputs:
      status: ${{ steps.compare.outputs.STATUS }}
      ipt_records: ${{ steps.compare.outputs.IPT_RECORDS }}
      gbif_records: ${{ steps.compare.outputs.GBIF_RECORDS }}
      ipt_version: ${{ steps.compare.outputs.IPT_VERSION }}
      last_modified_by: ${{ steps.compare.outputs.LAST_MODIFIED_BY }}
      overlap_pct: ${{ steps.compare.outputs.OVERLAP_PCT }}
      record_diff: ${{ steps.compare.outputs.RECORD_DIFF }}
      record_diff_pct: ${{ steps.compare.outputs.RECORD_DIFF_PCT }}
      has_large_record_change: ${{ steps.compare.outputs.HAS_LARGE_RECORD_CHANGE }}
    
    steps:
      - name: Check if issue already has checked label
        id: check-label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          echo "ISSUE_NUMBER=$ISSUE_NUM" >> $GITHUB_ENV
          
          LABELS=$(gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          
          if echo "$LABELS" | grep -q "^checked$"; then
            echo "Issue #$ISSUE_NUM already has 'checked' label, skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if echo "$LABELS" | grep -q "^Contacted$"; then
            echo "Issue #$ISSUE_NUM already has 'Contacted' label, skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.check-label.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Set up R
        if: steps.check-label.outputs.skip != 'true'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install system dependencies
        if: steps.check-label.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev

      - name: Install R dependencies
        if: steps.check-label.outputs.skip != 'true'
        run: |
          install.packages(c('rgbif', 'dplyr', 'rvest', 'stringr'), repos='https://cloud.r-project.org')
          cat("Installation complete. Checking installed packages:\n")
          cat("Library paths:", .libPaths(), "\n")
          cat("Installed packages:\n")
          print(installed.packages()[,c("Package", "LibPath")])
        shell: Rscript {0}

      - name: Verify R package installation
        if: steps.check-label.outputs.skip != 'true'
        run: |
          echo "R_LIBS_USER path: $R_LIBS_USER"
          echo "Checking library paths:"
          Rscript -e ".libPaths()"
          echo "Checking for rgbif:"
          Rscript -e "if('rgbif' %in% installed.packages()[,'Package']) { cat('rgbif is installed\n') } else { cat('rgbif NOT found\n'); q(status=1) }"

      - name: Check installation type
        if: steps.check-label.outputs.skip != 'true'
        id: check-type
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x pre-check/check_installation_type.sh
          bash pre-check/check_installation_type.sh ${{ env.ISSUE_NUMBER }}

      - name: Compare IPT and GBIF versions
        if: steps.check-label.outputs.skip != 'true' && steps.check-type.outputs.should_continue == 'true'
        id: compare
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        run: |
          chmod +x pre-check/run_version_comparison.sh
          bash pre-check/run_version_comparison.sh ${{ env.ISSUE_NUMBER }}

      - name: Add label for large record change
        if: steps.check-label.outputs.skip != 'true' && steps.compare.outputs.HAS_LARGE_RECORD_CHANGE == 'TRUE'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ env.ISSUE_NUMBER }} --add-label "occurrenceID - large change in record counts"
          echo "Added label: occurrenceID - large change in record counts"

      - name: Summary
        if: steps.check-label.outputs.skip != 'true' && always()
        run: |
          echo "## Version Comparison Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue**: #${{ env.ISSUE_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.compare.outputs.STATUS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **IPT Version**: ${{ steps.compare.outputs.IPT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Modified By**: ${{ steps.compare.outputs.LAST_MODIFIED_BY }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Record Counts" >> $GITHUB_STEP_SUMMARY
          echo "- **IPT Records**: ${{ steps.compare.outputs.IPT_RECORDS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GBIF Records**: ${{ steps.compare.outputs.GBIF_RECORDS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Difference**: ${{ steps.compare.outputs.RECORD_DIFF }} (${{ steps.compare.outputs.RECORD_DIFF_PCT }}%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Large Change**: ${{ steps.compare.outputs.HAS_LARGE_RECORD_CHANGE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OccurrenceID Overlap" >> $GITHUB_STEP_SUMMARY
          echo "- **Overlap**: ${{ steps.compare.outputs.OVERLAP_PCT }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Duplicates**: ${{ steps.compare.outputs.HAS_DUPLICATES }}" >> $GITHUB_STEP_SUMMARY

      - name: Add comment to issue
        if: steps.check-label.outputs.skip != 'true' && steps.compare.conclusion != 'skipped' && steps.compare.outputs.STATUS != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > comment.md
          ## Pre-check Results

          **Status:** ${{ steps.compare.outputs.STATUS }}

          ### IPT Resource
          - **IPT URL:** ${{ steps.compare.outputs.IPT_URL }}

          ### Version Information
          - **IPT Version:** ${{ steps.compare.outputs.IPT_VERSION }}
          - **Last Modified By:** ${{ steps.compare.outputs.LAST_MODIFIED_BY }}

          ### Record Counts
          - **IPT Records:** ${{ steps.compare.outputs.IPT_RECORDS }}
          - **GBIF Records:** ${{ steps.compare.outputs.GBIF_RECORDS }}
          - **Difference:** ${{ steps.compare.outputs.RECORD_DIFF }} (${{ steps.compare.outputs.RECORD_DIFF_PCT }}%)
          - **Large Change Detected:** ${{ steps.compare.outputs.HAS_LARGE_RECORD_CHANGE }}

          ### OccurrenceID Analysis
          - **Overlap:** ${{ steps.compare.outputs.OVERLAP_PCT }}%
          - **Has Duplicates:** ${{ steps.compare.outputs.HAS_DUPLICATES }}

          ### Sample OccurrenceIDs
          - **IPT Sample (first 5):** ${{ steps.compare.outputs.IPT_SAMPLE_IDS }}
          - **GBIF Sample (first 5):** ${{ steps.compare.outputs.GBIF_SAMPLE_IDS }}
          EOF
          
          gh issue comment ${{ env.ISSUE_NUMBER }} --body-file comment.md
          echo "✅ Added pre-check summary comment to issue #${{ env.ISSUE_NUMBER }}"

      - name: Mark issue as checked
        if: steps.check-label.outputs.skip != 'true' && steps.compare.outputs.STATUS != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ env.ISSUE_NUMBER }} --add-label "checked"
          echo "✅ Added 'checked' label to issue #${{ env.ISSUE_NUMBER }}"

  # Future pre-check jobs can be added here

